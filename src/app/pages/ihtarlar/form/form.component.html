<div class="container py-4" [class.opacity-50]="kaydediliyor()">
  <div class="d-flex justify-content-between align-items-center mb-3">
    <h3 class="m-0">{{ duzenlemeMi ? 'İhtar Düzenle' : 'Yeni İhtar Kaydı' }}</h3>
    <a class="btn btn-outline-secondary" [routerLink]="['/ihtarlar']">Listeye Dön</a>
  </div>

  <form [formGroup]="frm" (ngSubmit)="onSubmit()" novalidate>
    
    <h4 class="mt-4">Müşteri Bilgisi</h4><hr>
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Müşteri <span class="text-danger">*</span></label>
        
        @if (!frm.controls.musteriId.value) {
          <input 
            type="text" 
            class="form-control"
            id="musteriAramaInput"
            placeholder="Müşteri adı, unvanı veya TCKN ile arayın..."
            (input)="araMusteri($event)"
            [class.is-invalid]="submitted && f.musteriId.hasError('required')">
          
          @if (musteriAramaSonuclari().length > 0) {
            <ul class="list-group position-absolute z-3" style="max-height: 200px; overflow-y: auto;">
              @for (m of musteriAramaSonuclari(); track m.id) {
                <li class="list-group-item list-group-item-action" (click)="secMusteri(m)">
                  <strong>{{ m.adiUnvani }}</strong> ({{ m.musteriNo }})
                </li>
              }
            </ul>
          }
        }

        @if (frm.controls.musteriId.value) {
          <div class="input-group">
            <input type="text" class="form-control" formControlName="musteriSeciliAdi"
                   [class.is-invalid]="submitted && f.musteriId.hasError('required')">
            <button class="btn btn-outline-danger" type="button" (click)="temizleMusteri()" [disabled]="duzenlemeMi">Temizle</button>
          </div>
          @if (duzenlemeMi) {
            <small class="form-text text-muted">Müşteri bilgisi düzenleme modunda değiştirilemez.</small>
          }
        }
        
        @if (submitted && f.musteriId.hasError('required')) {
          <div class="text-danger small mt-1">Müşteri seçmek zorunludur.</div>
        }
      </div>
    </div>

    <h4 class="mt-4">İhtar Detayları</h4><hr>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">İhtar No</label>
        <input class="form-control" 
               formControlName="ihtarNo"
               [class.is-invalid]="(f.ihtarNo.touched || submitted) && f.ihtarNo.invalid" />
        @if ((f.ihtarNo.touched || submitted) && f.ihtarNo.invalid) {
          <div class="text-danger small mt-1">
            @if (f.ihtarNo.hasError('maxlength')) {
              <span>En fazla 50 karakter olabilir.</span>
            }
          </div>
        }
      </div>
      <div class="col-md-4">
        <label class="form-label">Noter Adı</label>
        <input class="form-control" 
               formControlName="noterAdi"
               [class.is-invalid]="(f.noterAdi.touched || submitted) && f.noterAdi.invalid" />
        @if ((f.noterAdi.touched || submitted) && f.noterAdi.invalid) {
          <div class="text-danger small mt-1">
            @if (f.noterAdi.hasError('maxlength')) {
              <span>En fazla 100 karakter olabilir.</span>
            }
          </div>
        }
      </div>
      <div class="col-md-4">
        <label class="form-label">Yevmiye No</label>
        <input class="form-control" 
               formControlName="yevmiyeNo"
               [class.is-invalid]="(f.yevmiyeNo.touched || submitted) && f.yevmiyeNo.invalid" />
        @if ((f.yevmiyeNo.touched || submitted) && f.yevmiyeNo.invalid) {
          <div class="text-danger small mt-1">
            @if (f.yevmiyeNo.hasError('maxlength')) {
              <span>En fazla 50 karakter olabilir.</span>
            }
          </div>
        }
      </div>

      <div class="col-md-4">
        <label class="form-label">İhtar Tarihi <span class="text-danger">*</span></label>
        <input 
          type="date" 
          class="form-control" 
          (keydown)="$event.preventDefault()" 
          style="cursor: pointer;"
          formControlName="ihtarTarihi"
          [class.is-invalid]="submitted && f.ihtarTarihi.hasError('required')" />
        @if (submitted && f.ihtarTarihi.hasError('required')) {
          <div class="text-danger small mt-1">İhtar tarihi zorunludur.</div>
        }
      </div>

      <div class="col-md-4">
        <label class="form-label">İhtarname Süresi (Gün)</label>
        <input 
          type="number" 
          class="form-control" 
          formControlName="ihtarnameSuresiGun" 
          min="0"
          [class.is-invalid]="(f.ihtarnameSuresiGun.touched || submitted) && f.ihtarnameSuresiGun.invalid" />
        @if ((f.ihtarnameSuresiGun.touched || submitted) && f.ihtarnameSuresiGun.invalid) {
          <div class="text-danger small mt-1">
            @if (f.ihtarnameSuresiGun.hasError('min')) {
              <span>Değer 0'dan küçük olamaz.</span>
            }
          </div>
        }
      </div>

      <div class="col-md-4">
        <label class="form-label">Tebliğ Tarihi</label>
        <input 
          type="date" 
          class="form-control" 
          (keydown)="$event.preventDefault()" 
          style="cursor: pointer;"
          formControlName="tebligTarihi" />
      </div>

      <div class="col-md-4">
        <label class="form-label">İhtar Tebliğ Giriş Tarihi</label>
        <input 
          type="date" 
          class="form-control" 
          (keydown)="$event.preventDefault()" 
          style="cursor: pointer;"
          formControlName="ihtarTebligGirisTarihi" />
      </div>

      <div class="col-md-4">
        <label class="form-label">Kat Tarihi</label>
        <input 
          type="date" 
          class="form-control" 
          (keydown)="$event.preventDefault()" 
          style="cursor: pointer;"
          formControlName="katTarihi" />
      </div>
    </div>

    <h4 class="mt-4">Tutar Bilgileri</h4><hr>
    <div class="row g-3">
      <div class="col-md-4">
        <label class="form-label">İhtarname Nakit Tutar <span class="text-danger">*</span></label>
        <input 
          type="number" 
          class="form-control" 
          formControlName="ihtarnameNakitTutar" 
          min="0"
          [class.is-invalid]="(f.ihtarnameNakitTutar.touched || submitted) && f.ihtarnameNakitTutar.invalid" />
        @if ((f.ihtarnameNakitTutar.touched || submitted) && f.ihtarnameNakitTutar.invalid) {
          <div class="text-danger small mt-1">
            @if (f.ihtarnameNakitTutar.hasError('required')) {
              <span>Nakit Tutar zorunludur.</span>
            }
            @if (f.ihtarnameNakitTutar.hasError('min')) {
              <span>Değer 0'dan küçük olamaz.</span>
            }
          </div>
        }
      </div>
      <div class="col-md-4">
        <label class="form-label">İhtarname Gayri Nakit Tutar <span class="text-danger">*</span></label>
        <input 
          type="number" 
          class="form-control" 
          formControlName="ihtarnameGayriNakitTutar" 
          min="0"
          [class.is-invalid]="(f.ihtarnameGayriNakitTutar.touched || submitted) && f.ihtarnameGayriNakitTutar.invalid" />
        @if ((f.ihtarnameGayriNakitTutar.touched || submitted) && f.ihtarnameGayriNakitTutar.invalid) {
          <div class="text-danger small mt-1">
            @if (f.ihtarnameGayriNakitTutar.hasError('required')) {
              <span>Gayri Nakit Tutar zorunludur.</span>
            }
            @if (f.ihtarnameGayriNakitTutar.hasError('min')) {
              <span>Değer 0'dan küçük olamaz.</span>
            }
          </div>
        }
      </div>
    </div>
    
    <h4 class="mt-4">Ek Bilgiler</h4><hr>
    <div class="row g-3">
      <div class="col-md-12">
        <label class="form-label">Müşteri Ürünleri (Sözleşme/Ürün No)</label>
        <textarea class="form-control" formControlName="musteriUrunleri" rows="3"></textarea>
      </div>
    </div>

    <div class="mt-4 d-flex gap-2">
      <button class="btn btn-primary" type="submit" [disabled]="kaydediliyor()">
        {{ kaydediliyor() ? 'Kaydediliyor...' : (duzenlemeMi ? 'Güncelle' : 'Kaydet') }}
      </button>
      <a class="btn btn-outline-secondary" [routerLink]="['/ihtarlar']" [class.disabled]="kaydediliyor()">İptal</a>
    </div>

  </form>
</div>
